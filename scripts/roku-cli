#!/usr/bin/env bash
# Roku CLI - Control your Roku from the command line
# Requires: pip3 install roku

set -e

ROKU_IP="${ROKU_IP:-}"

usage() {
    cat <<EOF
Usage: roku [OPTIONS] COMMAND [ARGS]

Control your Roku from the command line.

Options:
  --ip IP       Roku IP address (or set ROKU_IP env var)
  --help        Show this help

Commands:
  discover      Find Roku devices on network
  press BUTTON  Send button press (home | back | left | right | up | down | select | ...)
  text STRING   Enter text
  apps          List installed apps
  launch APP    Launch app (name or ID)
  active        Show active app
  info          Show device info

Examples:
  roku discover
  roku --ip 192.168.1.100 press home
  roku text "netflix"
  roku launch Hulu
  roku apps
EOF
    exit 0
}

die() {
    echo "Error: $1" >&2
    exit 1
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --ip)
            ROKU_IP="$2"
            shift 2
            ;;
        --help|-h)
            usage
            ;;
        *)
            break
            ;;
    esac
done

[[ $# -eq 0 ]] && usage
CMD="$1"
shift

# Helper to call python roku library
roku_python() {
    local code="$1"
    python3 -c "
import sys
from roku import Roku

ip = '${ROKU_IP}'
if ip:
    r = Roku(ip)
else:
    devices = Roku.discover(timeout=5)
    if not devices:
        print('No Roku devices found', file=sys.stderr)
        sys.exit(1)
    if len(devices) > 1:
        print('Multiple devices found, specify --ip', file=sys.stderr)
        sys.exit(1)
    r = devices[0]

$code
"
}

cmd_discover() {
    local timeout=5
    [[ "$1" =~ ^[0-9]+$ ]] && timeout="$1"
    echo "Searching for Roku devices..."
    python3 -c "
from roku import Roku
devices = Roku.discover(timeout=$timeout)
if not devices:
    print('No devices found')
else:
    for d in devices:
        print('  ' + str(d.host))
" || die "Discovery failed"
}

cmd_press() {
    local btn="$1"
    local event="$2"
    [[ -z "$btn" ]] && die "Button required: home back left right up down select ..."
    
    local event_code=""
    if [[ "$event" == "keydown" || "$event" == "keyup" ]]; then
        event_code=", '$event'"
    fi
    
    roku_python "getattr(r, '$btn')($event_code); print('Sent $btn')"
}

cmd_text() {
    local text="$*"
    [[ -z "$text" ]] && die "Text required"
    roku_python "r.literal('''$text'''); print('Entered: $text')"
}

cmd_apps() {
    echo "Installed apps:"
    roku_python "
for app in r.apps:
    print('  [' + str(app.id) + '] ' + app.name + ' v' + app.version)
"
}

cmd_launch() {
    local app="$1"
    [[ -z "$app" ]] && die "App name or ID required"
    roku_python "
try:
    app = r[int('$app')]
except:
    app = r['$app']
print('Launching ' + app.name + '...')
app.launch()
"
}

cmd_active() {
    roku_python "
app = r.active_app
if app:
    print('Active: [' + str(app.id) + '] ' + app.name + ' v' + app.version)
else:
    print('No active app')
    import sys
    sys.exit(1)
"
}

cmd_info() {
    roku_python "
print('Device: ' + r.host)
print('Apps installed: ' + str(len(r.apps)))
"
}

# Dispatch
case "$CMD" in
    discover)
        cmd_discover "${@:-}"
        ;;
    press)
        cmd_press "$1" "$2"
        ;;
    text)
        shift
        cmd_text "$@"
        ;;
    apps)
        cmd_apps
        ;;
    launch)
        cmd_launch "$1"
        ;;
    active)
        cmd_active
        ;;
    info)
        cmd_info
        ;;
    *)
        die "Unknown command: $CMD"
        ;;
esac
